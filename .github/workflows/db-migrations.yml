name: Database Migration Pipeline

on:
  pull_request:
    paths:
      - 'supabase/migrations/**'
      - 'supabase/verify/**'
      - '.github/workflows/db-migrations.yml'
      - 'scripts/migrate-*.sh'
  push:
    branches:
      - main
    paths:
      - 'supabase/migrations/**'
      - 'supabase/verify/**'

env:
  POSTGRES_IMAGE: postgres:15

jobs:
  # Stage A: Shadow Testing (runs on PRs)
  shadow-test:
    name: ğŸ§ª Shadow Test Migration
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: shadow_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for PostgreSQL
        run: |
          for i in {1..30}; do
            pg_isready -h localhost -p 5432 -U postgres && break
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Apply migrations in order
        run: |
          echo "ğŸ”„ Applying migrations to shadow database..."
          
          # Apply migrations in order
          for migration in supabase/migrations/*.sql; do
            if [ -f "$migration" ]; then
              echo "Applying: $migration"
              PGPASSWORD=postgres psql -h localhost -U postgres -d shadow_test -v ON_ERROR_STOP=1 -f "$migration"
              if [ $? -ne 0 ]; then
                echo "âŒ Migration failed: $migration"
                exit 1
              fi
            fi
          done
          
          echo "âœ… All migrations applied successfully"

      - name: Run verification checks
        run: |
          echo "ğŸ” Running verification checks..."
          
          PGPASSWORD=postgres psql -h localhost -U postgres -d shadow_test -f supabase/verify/verify.sql
          if [ $? -ne 0 ]; then
            echo "âŒ Verification failed"
            exit 1
          fi
          
          echo "âœ… Verification passed"

      - name: Run drift detection
        run: |
          echo "ğŸ” Running drift detection..."
          
          PGPASSWORD=postgres psql -h localhost -U postgres -d shadow_test -f supabase/verify/drift_check.sql
          if [ $? -ne 0 ]; then
            echo "âš ï¸ Drift check had issues (non-fatal)"
          else
            echo "âœ… Drift check passed"
          fi

      - name: Comment PR with results
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **Shadow test passed!** ğŸ§ª\n\nMigrations are safe for staging deployment.\n\n- âœ… All migrations applied successfully\n- âœ… Verification checks passed\n- âœ… Drift detection completed\n\nReady to merge! ï¿½ï¿½'
            })

  # Stage B: Staging Deployment (auto on main push)
  staging-deploy:
    name: ï¿½ï¿½ Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Apply migrations to staging
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          STAGING_PROJECT_REF: ${{ secrets.STAGING_PROJECT_REF }}
        run: |
          echo "ğŸ”„ Applying migrations to staging..."
          
          # Link to staging project
          supabase link --project-ref $STAGING_PROJECT_REF
          
          # Apply migrations using Supabase CLI
          supabase db push --include-all
          
          echo "âœ… Staging migrations applied"

      - name: Run staging verification
        env:
          STAGING_DB_URL: ${{ secrets.STAGING_DB_URL }}
        run: |
          echo "ğŸ” Running staging verification..."
          
          if [ ! -z "$STAGING_DB_URL" ] && command -v psql &> /dev/null; then
            psql "$STAGING_DB_URL" -f supabase/verify/verify.sql > staging_verify.log 2>&1
            psql "$STAGING_DB_URL" -f supabase/verify/drift_check.sql > staging_drift.log 2>&1
            
            echo "ğŸ“Š Staging verification results:"
            cat staging_verify.log
            echo "ğŸ“Š Staging drift check results:"
            cat staging_drift.log
          else
            echo "âš ï¸ Skipping verification - STAGING_DB_URL not set or psql not available"
          fi

      - name: Upload staging results
        uses: actions/upload-artifact@v4
        with:
          name: staging-migration-results
          path: |
            staging_verify.log
            staging_drift.log
        if: always()

  # Stage C: Production Deployment (manual approval required)
  production-deploy:
    name: ğŸ­ Deploy to Production
    runs-on: ubuntu-latest
    needs: staging-deploy
    environment: 
      name: production
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Apply migrations to production
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          PROD_PROJECT_REF: ${{ secrets.PROD_PROJECT_REF }}
        run: |
          echo "ğŸ”„ Applying migrations to PRODUCTION..."
          
          # Link to production project
          supabase link --project-ref $PROD_PROJECT_REF
          
          # Apply migrations using Supabase CLI
          supabase db push --include-all
          
          echo "âœ… Production migrations applied"

      - name: Run production verification
        env:
          PRODUCTION_DB_URL: ${{ secrets.PRODUCTION_DB_URL }}
        run: |
          echo "ğŸ” Running production verification..."
          
          if [ ! -z "$PRODUCTION_DB_URL" ] && command -v psql &> /dev/null; then
            psql "$PRODUCTION_DB_URL" -f supabase/verify/verify.sql > production_verify.log 2>&1
            psql "$PRODUCTION_DB_URL" -f supabase/verify/drift_check.sql > production_drift.log 2>&1
            
            echo "ğŸ“Š Production verification results:"
            cat production_verify.log
            echo "ğŸ“Š Production drift check results:"
            cat production_drift.log
          else
            echo "âš ï¸ Skipping verification - PRODUCTION_DB_URL not set or psql not available"
          fi

      - name: Upload production results
        uses: actions/upload-artifact@v4
        with:
          name: production-migration-results
          path: |
            production_verify.log
            production_drift.log
        if: always()

      - name: Notify success
        run: |
          echo "ğŸ‰ Production migration completed successfully!"
          echo "ğŸ“Š Monitor application logs for any issues"
          echo "ğŸ”— Migration artifacts available in job summary"
