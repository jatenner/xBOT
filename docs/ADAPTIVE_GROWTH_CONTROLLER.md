# ðŸŽ¯ Adaptive Growth Controller

The Adaptive Growth Controller makes reward-driven decisions about posting cadence, sourcing weights, and strategy weights based on real performance data (followers, impressions, bookmarks, resistance signals).

## Overview

The controller operates in two modes:

1. **Shadow Mode** (default): Generates plans but does NOT enforce them. Safe for testing.
2. **Enforce Mode**: Actively controls posting rates and strategy selection when `GROWTH_CONTROLLER_ENABLED=true`.

## Architecture

### Plan Generation

Hourly plans are generated by `shadowControllerJob` which:

1. **Analyzes Recent Rewards** (last 24-72h):
   - Follower deltas from `account_snapshots`
   - Impressions/bookmarks from `performance_snapshots`
   - Reward scores from `reward_features`

2. **Adaptive Targeting**:
   - Adjusts `target_posts` and `target_replies` based on reward trends
   - Respects hard envelopes (MIN/MAX from env vars)
   - Max step change: +/-1 posts, +/-2 replies per hour
   - Increases only if reward improving AND resistance low
   - Decreases if reward falling OR resistance rising

3. **Strategy Weights**:
   - Topics: Prioritizes top-performing topics (from `daily_aggregates`)
   - Formats: Prioritizes top-performing formats
   - Generators: Prioritizes top-performing generators

4. **Platform Resistance**:
   - Monitors CONSENT_WALL, POST_FAIL, CHALLENGE signals
   - Automatically reduces targets by 50% if thresholds exceeded
   - Logs backoff reason

### Enforcement

When `GROWTH_CONTROLLER_ENABLED=true`:

1. **Posting Queue** checks `canPost()` before each post/reply
2. **Content Generation** uses strategy weights to select topics/generators
3. **Reply Orchestrator** uses feed weights to select candidate sources
4. **Execution Tracking** records posts/replies in `growth_execution`

## Configuration

### Environment Variables

```bash
# Controller Mode
GROWTH_CONTROLLER_ENABLED=false  # Set to 'true' to enable enforcement
GROWTH_CONTROLLER_MODE=shadow    # 'shadow' or 'enforce' (shadow is default even when enabled)

# Hard Envelopes (safety caps)
MIN_POSTS_PER_HOUR=1
MAX_POSTS_PER_HOUR=4
MIN_REPLIES_PER_HOUR=2
MAX_REPLIES_PER_HOUR=8

# Adaptive Step Limits
GROWTH_CONTROLLER_MAX_STEP_POSTS=1
GROWTH_CONTROLLER_MAX_STEP_REPLIES=2

# Resistance Thresholds
RESISTANCE_CONSENT_WALL_THRESHOLD=5
RESISTANCE_POST_FAIL_THRESHOLD=10
```

### Shadow Mode (Recommended First)

Run in shadow mode for 24h before enabling enforcement:

```bash
# Generate plan (does not enforce)
pnpm run runner:shadow-controller-once

# Check latest plan
SELECT * FROM growth_plans ORDER BY window_start DESC LIMIT 1;

# Verify plan reasons
SELECT * FROM system_events 
WHERE event_type = 'GROWTH_PLAN_REASON' 
ORDER BY created_at DESC LIMIT 5;
```

### Enforce Mode

To enable enforcement:

```bash
export GROWTH_CONTROLLER_ENABLED=true
export GROWTH_CONTROLLER_MODE=enforce  # Optional, 'shadow' is default

# Restart runner/daemon
```

## Plan Generation

Plans are generated hourly and stored in `growth_plans`:

```sql
SELECT 
  window_start,
  target_posts,
  target_replies,
  resistance_backoff_applied,
  backoff_reason,
  reason_summary
FROM growth_plans
ORDER BY window_start DESC
LIMIT 24;
```

### Plan Structure

- **window_start/end**: Hour window the plan applies to
- **target_posts/replies**: Allowed posts/replies for that hour
- **feed_weights**: Distribution across candidate sources (curated/keyword/viral/discovered)
- **strategy_weights**: Prioritization of topics/formats/generators
- **resistance_backoff_applied**: Whether backoff was triggered
- **backoff_reason**: Explanation of why backoff was applied
- **reason_summary**: Human-readable explanation of plan decisions

## Adaptive Logic

### Reward Analysis

The controller analyzes:
- **24h reward average**: Recent performance
- **72h reward average**: Longer-term trend
- **Trend**: increasing/decreasing/flat
- **Follower delta**: Net follower gain/loss
- **Impressions/bookmarks**: Engagement signals

### Targeting Rules

1. **Increase targets** if:
   - Reward trend is increasing
   - 24h avg reward > 0
   - Follower growth positive OR good engagement (bookmarks > 2 avg)
   - Resistance signals low

2. **Decrease targets** if:
   - Reward trend is decreasing OR 24h avg reward < 0
   - Follower loss > 5
   - Resistance signals high

3. **Maintain targets** if:
   - No significant trend
   - Mixed signals

### Step Limits

Changes are gradual:
- Posts: Max +/-1 per hour
- Replies: Max +/-2 per hour
- Always respects MIN/MAX envelopes

## Strategy Weights

### How They're Computed

From `daily_aggregates` (last 7 days):
- Top-performing topics (by avg_reward_score)
- Top-performing formats
- Top-performing generators

Weights are normalized (sum to 1.0) and used for weighted random selection.

### How They're Applied

**Content Generation:**
- Topic selection uses weighted random from top topics
- Generator selection uses weighted random from top generators
- Format selection respects format weights

**Reply Generation:**
- Feed weights already wired into orchestrator
- Reply style/topic focus weights (if present) influence candidate scoring

## Platform Resistance

### Signals Monitored

1. **CONSENT_WALL**: Rate of consent wall hits (threshold: 5/hour)
2. **POST_FAIL**: Burst of post failures (threshold: 10/hour)
3. **CHALLENGE**: Any challenge events (threshold: 1/hour)

### Backoff Behavior

When resistance detected:
- Targets reduced by 50%
- Minimum enforced: Never below 1 post, 1 reply
- Reason logged in `backoff_reason`
- Plan marked with `resistance_backoff_applied=true`

## Execution Tracking

Plans are tracked in `growth_execution`:

```sql
SELECT 
  ge.plan_id,
  ge.posts_done,
  ge.replies_done,
  gp.target_posts,
  gp.target_replies,
  (gp.target_posts - ge.posts_done) as posts_remaining,
  (gp.target_replies - ge.replies_done) as replies_remaining
FROM growth_execution ge
JOIN growth_plans gp ON ge.plan_id = gp.plan_id
WHERE gp.window_start >= NOW() - INTERVAL '24 hours'
ORDER BY gp.window_start DESC;
```

**Idempotency:** The `increment_growth_execution()` function ensures counters are updated atomically.

## Explainability

Every plan generates two events:

1. **SHADOW_PLAN**: Backward compatibility event
2. **GROWTH_PLAN_REASON**: Detailed explanation including:
   - Previous vs new targets
   - Reward analysis (trend, averages, deltas)
   - Resistance status
   - Backoff reason (if applicable)

Query recent reasons:

```sql
SELECT 
  event_data->>'reason_summary' as reason,
  event_data->>'previous_targets' as previous,
  event_data->>'new_targets' as new,
  created_at
FROM system_events
WHERE event_type = 'GROWTH_PLAN_REASON'
ORDER BY created_at DESC
LIMIT 10;
```

## Testing

### Test Plan Generation

```bash
pnpm run runner:controller-recompute-once
```

This generates a plan and prints:
- Previous targets vs new targets
- Reason summary
- Analysis details

### Verify Enforcement

1. Set tiny targets:
```sql
UPDATE growth_plans 
SET target_posts = 0, target_replies = 1
WHERE plan_id = (SELECT plan_id FROM growth_plans ORDER BY window_start DESC LIMIT 1);
```

2. Enable controller:
```bash
export GROWTH_CONTROLLER_ENABLED=true
```

3. Run posting:
```bash
pnpm run runner:schedule-once
```

4. Check logs for:
- `[GROWTH_CONTROLLER] âœ… Allowed` - Allowed posts
- `[GROWTH_CONTROLLER] â›” BLOCKED` - Blocked by plan

### Verify Strategy Weights

```sql
SELECT 
  strategy_weights->'topics' as topics,
  strategy_weights->'formats' as formats,
  strategy_weights->'generators' as generators
FROM growth_plans
ORDER BY window_start DESC
LIMIT 1;
```

Check logs during content generation for:
- `ðŸŽ¯ Using strategy-weighted generator: ...`
- `ðŸŽ¯ Using strategy-weighted topic: ...`

## Rollout Strategy

### Phase 1: Shadow Mode (Week 1)

1. Ensure telemetry tables are populated
2. Run plan generation hourly
3. Monitor plans and reasons
4. Verify targets adjust based on rewards

### Phase 2: Shadow Mode with Strategy Weights (Week 2)

1. Verify strategy weights are computed
2. Check that content generation uses weights (logs)
3. Monitor if top performers are being prioritized

### Phase 3: Enforcement (Week 3+)

1. Enable `GROWTH_CONTROLLER_ENABLED=true`
2. Monitor enforcement logs
3. Verify counters increment correctly
4. Check no overruns (targets respected)

### Phase 4: Full Autonomy

1. Let controller adjust freely within envelopes
2. Monitor reward trends improve over time
3. Tune heuristics based on results

## Safety

### Hard Envelopes

Always enforced regardless of controller recommendations:
- `MIN_POSTS_PER_HOUR` - Never below this
- `MAX_POSTS_PER_HOUR` - Never above this
- `MIN_REPLIES_PER_HOUR` - Never below this
- `MAX_REPLIES_PER_HOUR` - Never above this

### Fail-Closed Behavior

If controller fails to load plan:
- Falls back to rate limiter
- Logs warning
- System continues operating

### Kill Switch

To disable instantly:
```bash
export GROWTH_CONTROLLER_ENABLED=false
# Restart runner/daemon
```

## Monitoring

### Key Metrics

1. **Plan Targets vs Execution**:
```sql
SELECT 
  DATE_TRUNC('hour', window_start) as hour,
  AVG(target_posts) as avg_target_posts,
  AVG(target_replies) as avg_target_replies,
  SUM(posts_done) as total_posts_done,
  SUM(replies_done) as total_replies_done
FROM growth_plans gp
LEFT JOIN growth_execution ge ON gp.plan_id = ge.plan_id
WHERE window_start >= NOW() - INTERVAL '7 days'
GROUP BY DATE_TRUNC('hour', window_start)
ORDER BY hour DESC;
```

2. **Backoff Frequency**:
```sql
SELECT 
  DATE_TRUNC('day', window_start) as day,
  COUNT(*) FILTER (WHERE resistance_backoff_applied) as backoffs,
  COUNT(*) as total_plans
FROM growth_plans
WHERE window_start >= NOW() - INTERVAL '7 days'
GROUP BY DATE_TRUNC('day', window_start)
ORDER BY day DESC;
```

3. **Reward Trends**:
```sql
SELECT 
  DATE_TRUNC('day', posted_at) as day,
  AVG(reward_score) as avg_reward,
  COUNT(*) as decision_count
FROM reward_features
WHERE posted_at >= NOW() - INTERVAL '30 days'
GROUP BY DATE_TRUNC('day', posted_at)
ORDER BY day DESC;
```

## Troubleshooting

### Plans Not Generating

Check logs:
```bash
pnpm run runner:shadow-controller-once
```

Common issues:
- Telemetry tables missing â†’ Apply migrations
- No recent rewards â†’ System needs time to collect data
- Database connection issues â†’ Check DATABASE_URL

### Enforcement Not Working

Verify:
1. `GROWTH_CONTROLLER_ENABLED=true`
2. Active plan exists for current hour
3. `canPost()` is being called in postingQueue
4. Logs show controller checks

### Strategy Weights Not Applied

Check:
1. Plans have strategy_weights populated
2. Content generation logs show "strategy-weighted" messages
3. `getStrategyWeights()` returns non-empty weights

---

**Next Steps:** See `docs/MAC_RUNNER_24_7.md` for Mac runner setup, then enable controller in shadow mode.
